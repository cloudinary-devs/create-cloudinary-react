name: Publish Package

on:
  workflow_dispatch:
    inputs:
      publish_beta:
        description: 'Publish as beta version?'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Verify admin permissions
        run: |
          # Check if the actor is a repository admin
          PERMISSION=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/collaborators/${{ github.actor }}/permission" \
            | grep -o '"permission":"[^"]*"' | cut -d'"' -f4)
          
          if [ "$PERMISSION" != "admin" ]; then
            echo "Error: Only repository admins can trigger publishing. Current permission: $PERMISSION"
            exit 1
          fi
          
          echo "âœ“ Verified admin permission for ${{ github.actor }}"

      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Handle beta version
        if: inputs.publish_beta == true
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          
          echo "ğŸ” Checking existing beta versions for $BASE_VERSION..."
          
          # Get all published versions from npm (public packages don't need auth)
          VERSIONS_JSON=$(npm view "$PACKAGE_NAME" versions --json 2>/dev/null || echo "[]")
          
          # Find the highest beta version for this base version
          BETA_NUM=$(node -e "
            const versions = JSON.parse('$VERSIONS_JSON' || '[]');
            const base = '$BASE_VERSION';
            const matching = versions
              .filter(v => typeof v === 'string' && v.startsWith(base + '-beta.'))
              .map(v => {
                const match = v.match(/-beta\.(\d+)$/);
                return match ? parseInt(match[1]) : 0;
              })
              .filter(n => !isNaN(n) && n > 0);
            
            const nextBeta = matching.length > 0 ? Math.max(...matching) + 1 : 1;
            console.log(nextBeta);
          ")
          
          BETA_VERSION="${BASE_VERSION}-beta.${BETA_NUM}"
          
          # Update package.json with beta version
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$BETA_VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          
          echo "ğŸ“¦ Beta version determined: $BETA_VERSION"
          echo "version=$BETA_VERSION" >> $GITHUB_ENV

      - name: Display version to publish
        run: |
          if [ "${{ inputs.publish_beta }}" != "true" ]; then
            VERSION=$(node -p "require('./package.json').version")
            echo "version=$VERSION" >> $GITHUB_ENV
          fi
          echo "ğŸ“¦ Publishing version: ${{ env.version }}"

      - run: npm ci

      - run: npm test --if-present

      - run: npm publish
